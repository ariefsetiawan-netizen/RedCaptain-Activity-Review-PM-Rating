<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RedCaptain — Rate Your PM</title>
  <style>
    :root{
      --brand:#ec2224;
      --ink:#303030;
      --muted:#666;
      --bg:#e9e9e9;
      --card:#ffffff;
      --stroke:#ddd;
      --pill:#fafafa;
      --ok:#19a45b;
      --warn:#c62828;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      margin:0;
      font-family:Arial, Helvetica, sans-serif;
      color:var(--ink);
    }
    .frame{
      max-width:720px;
      margin:0 auto;
      background:#f5f5f5;
      border-top:3px solid var(--brand);
      min-height:100vh;
    }
    .header{
      text-align:center;
      padding:22px 16px 8px 16px;
    }
    .header img{height:28px}
    .title{ padding:0 24px 16px 24px; text-align:center; }
    .title h2{ margin:12px 0 6px 0; font-weight:700; font-size:18px; color:var(--ink); }
    .title .sub{ color:var(--muted); font-size:13px; }
    .card{ margin:0 16px 16px 16px; background:var(--card); border:1px solid var(--stroke); border-radius:8px; overflow:hidden; }
    .card .card-h{ padding:14px 16px; border-bottom:1px solid #eee; font-weight:bold; color:var(--ink); background:#fff; }
    .kv{ width:100%; border-collapse:collapse; font-size:13px; color:var(--ink); }
    .kv td{ padding:10px 16px; vertical-align:top; }
    .kv tr:nth-child(2n){ background:#fafafa; }
    .kv td.k{ width:42%; color:var(--muted); }
    .attachments a{ color:var(--brand); text-decoration:none; }
    /* Rating section */
    .stars{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:12px 16px 4px 16px; }
    .star-wrap{ text-align:center; }
    .star-btn{ display:inline-block; background:var(--pill); border:1px solid var(--stroke); border-radius:8px; padding:10px 14px; font-size:16px; color:var(--ink); text-decoration:none; cursor:pointer; user-select:none; min-width:56px; text-align:center; }
    .star-btn.active{ border-color:var(--brand); box-shadow:0 0 0 2px rgba(236,34,36,.12) inset; }
    .star-caption{ display:block; font-size:11px; color:var(--muted); margin-top:4px; text-align:center; }
    .pillbar{ padding:0 16px 12px 16px; display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ border:1px solid var(--stroke); background:var(--pill); color:var(--ink); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; user-select:none; }
    .pill.active{ border-color:var(--brand); box-shadow:0 0 0 2px rgba(236,34,36,.12) inset; }
    .field{ padding:0 16px 16px 16px; }
    textarea{ width:100%; min-height:120px; resize:vertical; border:1px solid var(--stroke); padding:10px; border-radius:6px; font-family:inherit; font-size:13px; color:var(--ink); background:#fff; }
    .actions{ display:flex; gap:10px; padding:16px; border-top:1px solid #eee; background:#fff; }
    .btn{ display:inline-block; padding:10px 14px; border-radius:6px; font-weight:700; text-decoration:none; border:1px solid var(--stroke); background:#fff; color:var(--ink); cursor:pointer; user-select:none; }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn:disabled, .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .footer{ background:#f5f5f5; border-top:1px solid #eee; padding:14px 16px; color:var(--muted); font-size:12px; }
    .copyright{ background:#303030; color:#fff; text-align:center; padding:12px 8px; font-size:12px; }
    .banner{ margin:0 16px 12px 16px; border-radius:8px; border:1px solid #e3e3e3; padding:10px 12px; font-size:13px; color:#1f482a; background:#eaf6ee; display:none; }
    .banner.error{ color:#5b1b1b; background:#fdeaea; border-color:#f3c7c7; display:block; }
    /* Stronger success style so it stands out from page background */
    .banner.success{
      color:#fff; /* high contrast text */
      background: linear-gradient(180deg,#2fb05a 0%, #1f8f45 100%);
      border-color:rgba(19,120,60,0.6);
      box-shadow: 0 6px 18px rgba(31,143,69,0.12);
      display:block; /* visible when shown by script */
      font-weight:700;
      padding:12px 16px;
      position:relative;
      border-left:4px solid rgba(12,90,40,0.9);
      border-radius:8px;
    }
    .banner.success::before{
      /* subtle inline checkmark badge */
      content:"\2714";
      display:inline-block;
      width:22px;
      height:22px;
      line-height:22px;
      margin-right:10px;
      text-align:center;
      background:rgba(255,255,255,0.12);
      color:#fff;
      border-radius:50%;
      font-size:13px;
      vertical-align:middle;
    }
    /* visible class triggers a small entrance animation */
    .banner.success.visible{
      animation: ryb-slide-down .28s ease both;
    }
    @keyframes ryb-slide-down{
      from{ transform: translateY(-6px); opacity:0 }
      to{ transform: translateY(0); opacity:1 }
    }
    .meta{ color:var(--muted); font-size:12px; padding:0 16px 12px 16px; }
    details.dev{ margin:12px 16px 24px 16px; background:#fff; border:1px dashed #ccc; border-radius:8px; padding:10px 12px; font-size:12px; color:#444; }
    code{font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px;}
    .sr{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;}
  </style>
</head>
<body>
  <div class="frame">
    <!-- Header -->
    <div class="header">
      <img id="rcLogo" src="https://mo-rs-ra-rp-uat-130.s3.amazonaws.com/captain/static_content/new-lglogo.png" alt="RedCaptain">
    </div>

    <!-- Title -->
    <div class="title">
      <h2>Rate Your Property Manager</h2>
      <div class="sub">Please gives rating to your Activity & Property Manager</div>
    </div>

    <!-- Token error / success banner -->
  <div id="tokenBanner" class="banner error">Invalid or expired link. Please contact your RedDoorz representative.</div>
  <div id="okBanner" class="banner success" style="display:none;" role="status" aria-live="polite" tabindex="-1">Thank you! Your rating has been recorded.</div>

    <!-- Activity Snapshot -->
    <div class="card">
      <div class="card-h">Details</div>
      <table class="kv">
        <tr>
          <td class="k">Property Manager</td>
          <td id="kvPM"><b>-</b></td>
        </tr>
        <tr>
          <td class="k">Property</td>
          <td id="kvProperty"><b>-</b></td>
        </tr>
        <tr>
          <td class="k">Activity At</td>
          <td id="kvWhen">-</td>
        </tr>
        <tr>
          <td class="k">Activity Type</td>
          <td id="kvType">-</td>
        </tr>
        <tr>
          <td class="k">Subject</td>
          <td id="kvSubject">-</td>
        </tr>
      </table>
      <div class="meta" id="kvMeta"></div>
    </div>

    <!-- Rating card -->
    <form id="rateForm" class="card" novalidate>
      <div class="card-h">Your Rating</div>

      <!-- Stars -->
      <div class="stars" id="starsBar" aria-label="Select a rating from 1 to 5 stars"></div>

      <!-- Quick tags (dynamic per star) -->
      <div class="pillbar" id="tagsBar" aria-label="Select predefined tags"></div>

      <!-- Free text -->
      <div class="field">
        <label for="comment" class="sr">Comments</label>
        <textarea id="comment" placeholder="Optional: add details that would help our team (max 500 chars)" maxlength="500"></textarea>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="submitBtn" class="btn primary" type="submit" disabled>Submit Rating</button>
      </div>
    </form>

    <!-- Footer -->
    <div class="footer">Need help? <a href="mailto:cs@reddoorz.com" style="color:var(--brand);text-decoration:none;">cs@reddoorz.com</a></div>
    <div class="copyright">© 2025 RedDoorz</div>

  <script>
    (function(){
      // --- Image fallback to prevent broken logo ---
      const rcLogo = document.getElementById('rcLogo');
      rcLogo.addEventListener('error', ()=>{
        rcLogo.onerror=null;
        rcLogo.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="28"><rect width="160" height="28" fill="#ffffff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="14" fill="#ec2224">RedCaptain</text></svg>`);
      });

      const params = new URLSearchParams(location.search);
      const token = params.get('token') || 'demo-token-123';
      const prefillStar = parseInt(params.get('s') || '4', 10); // default 4★
      const kv = {
        property: params.get('property') || 'RedDoorz Plus near Mall Ciputra Jakarta',
        when: params.get('when') || '03 Oct 2025, 09:00 WIB',
        type: params.get('type') || 'Property Visit',
        subject: params.get('subject') || 'Property & Room Check',
        pm_name: params.get('pm_name') || 'Arief Setiawan',
        pm_phone: params.get('pm_phone') || '6281299990000'
      };

      // Token banner
      const tokenBanner = document.getElementById('tokenBanner');
      const okBanner = document.getElementById('okBanner');
      const form = document.getElementById('rateForm');
      const submitBtn = document.getElementById('submitBtn');

      if(!token || token.trim().length < 8){ tokenBanner.style.display = 'block'; }
      else { tokenBanner.style.display = 'none'; }

      // Fill snapshot with sample defaults
      document.getElementById('kvProperty').innerHTML = '<b>'+escapeHtml(kv.property)+'</b>';
      document.getElementById('kvWhen').textContent = kv.when;
      document.getElementById('kvType').textContent = kv.type;
      document.getElementById('kvSubject').textContent = kv.subject;
      document.getElementById('kvPM').innerHTML = '<b>'+escapeHtml(kv.pm_name)+' · '+escapeHtml(kv.pm_phone)+'</b>';
      document.getElementById('kvMeta').textContent = '';

      // --- Stars ---
      const starLabels = ['Poor','Fair','Good','Very Good','Excellent'];
      const starsBar = document.getElementById('starsBar');
      let currentStar = (prefillStar>=1 && prefillStar<=5) ? prefillStar : 0;

      for(let i=1;i<=5;i++){
        const wrap = document.createElement('div');
        wrap.className = 'star-wrap';
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'star-btn' + (i===currentStar ? ' active' : '');
        a.dataset.star = String(i);
        a.textContent = '★ ' + i;
        a.addEventListener('click', (e)=>{ e.preventDefault(); setStar(i); });
        const cap = document.createElement('span');
        cap.className = 'star-caption';
        cap.textContent = starLabels[i-1];
        wrap.appendChild(a); wrap.appendChild(cap); starsBar.appendChild(wrap);
      }

      function paintStars(){
        document.querySelectorAll('.star-btn').forEach(el=>{
          el.classList.toggle('active', parseInt(el.dataset.star,10) === currentStar);
        });
      }

      // --- Dynamic tag sets per star ---
      const STAR_TAGS = {
        1: [
          {key:'late', label:'Late'},
          {key:'unprepared', label:'Unprepared'},
          {key:'poor_comm', label:'Poor communication'},
          {key:'not_resolved', label:'Did not resolve'},
          {key:'followup_required', label:'Follow-up required'}
        ],
        2: [
          {key:'slightly_late', label:'Slightly late'},
          {key:'needs_prep', label:'Needs more prep'},
          {key:'unclear_updates', label:'Unclear updates'},
          {key:'partial_resolution', label:'Partial resolution'},
          {key:'followup_required', label:'Follow-up required'}
        ],
        3: [
          {key:'on_time', label:'On time'},
          {key:'clear_updates', label:'Clear updates'},
          {key:'adequate_prep', label:'Adequate prep'},
          {key:'partial_resolution', label:'Partial resolution'},
          {key:'followup_required', label:'Needs follow-up'}
        ],
        4: [
          {key:'on_time', label:'On time'},
          {key:'prepared', label:'Prepared'},
          {key:'helpful', label:'Helpful'},
          {key:'clear_updates', label:'Clear updates'},
          {key:'resolved', label:'Resolved issues'}
        ],
        5: [
          {key:'outstanding', label:'Outstanding'},
          {key:'proactive', label:'Proactive'},
          {key:'above_beyond', label:'Above & beyond'},
          {key:'clear_updates', label:'Clear updates'},
          {key:'on_time', label:'On time'}
        ]
      };
      const DEFAULT_SELECTED = { 1:['not_resolved','followup_required'], 2:['followup_required'], 3:['clear_updates'], 4:['on_time','prepared','clear_updates'], 5:['outstanding','proactive','clear_updates'] };
      const tagsBar = document.getElementById('tagsBar');
      let selected = new Set();

      function renderTagsForStar(star){
        tagsBar.innerHTML = '';
        selected = new Set(DEFAULT_SELECTED[star] || []);
        (STAR_TAGS[star] || []).forEach(t=>{
          const pill = document.createElement('span');
          pill.className = 'pill' + (selected.has(t.key) ? ' active' : '');
          pill.textContent = t.label;
          pill.dataset.key = t.key;
          pill.addEventListener('click', ()=>{
            if(selected.has(t.key)){ selected.delete(t.key); pill.classList.remove('active'); }
            else { selected.add(t.key); pill.classList.add('active'); }
          });
          tagsBar.appendChild(pill);
        });
      }

      function setStar(v){
        currentStar = v; paintStars(); renderTagsForStar(v); syncSubmitState();
      }

      // Comment
      const commentEl = document.getElementById('comment');

      // Submit
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!currentStar) return;
        const payload = {
          token: token || null,
          rating: currentStar,
          tags: Array.from(selected.values()),
          comment: commentEl.value || '',
          submitted_at: new Date().toISOString(),
          client_meta: { ua: navigator.userAgent, tz: Intl.DateTimeFormat().resolvedOptions().timeZone },
          context: kv
        };
        console.log('POST /owner-rating payload:', payload);
        // show success banner with entrance animation and move focus for accessibility
        okBanner.style.display = 'block';
        okBanner.classList.add('visible');
        try{ okBanner.focus(); }catch(e){}
        submitBtn.disabled = true;
      });

      function syncSubmitState(){ submitBtn.disabled = !currentStar || (!token || token.trim().length < 8); }

      // Prefill on load with samples
      setStar(currentStar || 4);
      syncSubmitState();

      // Utils
      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
    })();
  </script>
</body>
</html>
